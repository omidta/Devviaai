name: Idea Management - Auto Label & Notify

on:
  issues:
    types: [opened, labeled, unlabeled]

permissions:
  issues: write
  contents: read

jobs:
  auto-label-ideas:
    name: Auto-label new ideas
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'idea') && contains(github.event.issue.labels.*.name, 'new')
    
    steps:
      - name: Add stage label
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title.toLowerCase();
            const body = context.payload.issue.body || '';
            
            // Determine which stage this idea affects
            let stageLabel = null;
            if (body.includes('Stage 1') || body.includes('Discover & Design')) {
              stageLabel = 'stage-1';
            } else if (body.includes('Stage 2') || body.includes('Develop & Build')) {
              stageLabel = 'stage-2';
            } else if (body.includes('Stage 3') || body.includes('Deploy & Deliver')) {
              stageLabel = 'stage-3';
            } else if (body.includes('Stage 4') || body.includes('Validate & Operate')) {
              stageLabel = 'stage-4';
            }
            
            if (stageLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: [stageLabel]
              });
            }

      - name: Add idea pool comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üéâ Thank you for submitting your idea!

This idea has been added to the **Idea Pool** and will be reviewed by the team.

### üìã Next Steps

1. **Community Discussion** (Optional): Feel free to share this in [Discussions](https://github.com/${context.repo.owner}/${context.repo.repo}/discussions) for community feedback
2. **Team Review**: The team will review this idea and update the label to \`under review\` when evaluation begins
3. **Validation**: If validated, the idea will move to \`approved\` status and may be added to a milestone
4. **Implementation**: Approved ideas will be prioritized and may be assigned for implementation

### üè∑Ô∏è Status Labels

- \`new\` ‚Üí \`under review\` ‚Üí \`approved\` / \`not feasible\`
- Track progress via [Project Board](https://github.com/${context.repo.owner}/${context.repo.repo}/projects)

### üí° How You Can Help

- Provide additional context if requested
- Help validate the hypothesis with data
- Contribute to implementation if you're able
- Share feedback from your experience

Thank you for contributing to improving the Devviaai framework! üöÄ`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: comment
            });

  notify-on-review:
    name: Notify on review stage
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'under review')
    
    steps:
      - name: Add review notification
        uses: actions/github-script@v7
        with:
          script: |
            // Check if this is a new 'under review' label
            const wasJustLabeled = context.payload.action === 'labeled' && 
                                  context.payload.label.name === 'under review';
            
            if (wasJustLabeled) {
              const comment = `## üîç Idea Under Review

This idea is now under review by the team.

### Review Process

The team will evaluate this idea based on:

1. **Alignment**: Does it align with framework principles?
2. **Value**: What value does it provide to users?
3. **Feasibility**: Can it be implemented with reasonable effort?
4. **Impact**: What is the expected impact?
5. **Resources**: What resources are required?

### Timeline

- **Initial Review**: 1-2 weeks
- **Decision**: The issue will be labeled as \`approved\` or \`not feasible\`
- **Planning**: Approved ideas will be added to a milestone and project board

### Feedback Welcome

Please feel free to add additional context or respond to questions from reviewers.

---
*This is an automated message. A team member will engage with this issue soon.*`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: comment
              });
            }

  notify-on-approved:
    name: Notify on approval
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'approved')
    
    steps:
      - name: Add approval notification
        uses: actions/github-script@v7
        with:
          script: |
            const wasJustLabeled = context.payload.action === 'labeled' && 
                                  context.payload.label.name === 'approved';
            
            if (wasJustLabeled) {
              const comment = `## ‚úÖ Idea Approved!

Congratulations! This idea has been approved for implementation.

### üéØ Next Steps

1. **Prioritization**: This will be prioritized against other approved ideas
2. **Milestone**: Will be assigned to an upcoming milestone/release
3. **Project Board**: Will be added to the project board for tracking
4. **Implementation**: 
   - Assigned to a team member or open for contributors
   - A linked PR will track implementation progress
   - Updates will be posted here

### üìä Tracking

You can track progress via:
- This issue (status updates will be posted)
- [Project Board](https://github.com/${context.repo.owner}/${context.repo.repo}/projects)
- Related milestone

### ü§ù Contributing

If you'd like to contribute to the implementation:
1. Comment on this issue expressing interest
2. Wait for assignment or guidance from maintainers
3. Follow the PR template when submitting code

Thank you for this valuable contribution to the framework! üéâ`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: comment
              });
            }

  notify-on-not-feasible:
    name: Notify on not feasible
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'not feasible')
    
    steps:
      - name: Add not feasible notification
        uses: actions/github-script@v7
        with:
          script: |
            const wasJustLabeled = context.payload.action === 'labeled' && 
                                  context.payload.label.name === 'not feasible';
            
            if (wasJustLabeled) {
              const comment = `## ‚ÑπÔ∏è Idea Not Feasible

After review, this idea has been determined to be not feasible at this time.

A team member will provide detailed reasoning for this decision. Common reasons include:

- Does not align with framework principles or goals
- Technical constraints or limitations
- Resource constraints
- Overlaps with existing functionality
- Timing or prioritization concerns

### üí≠ What This Means

- This issue will be closed
- The idea is documented for future reference
- Lessons learned will be captured
- You're encouraged to refine and resubmit if circumstances change

### üîÑ If You Disagree

If you believe this decision should be reconsidered:
1. Provide additional context or evidence
2. Address the concerns raised by reviewers
3. Request a re-review from maintainers

Thank you for your contribution and understanding! Your participation helps improve the framework. üôè`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: comment
              });
            }
